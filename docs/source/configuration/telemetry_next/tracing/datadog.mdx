---
title: Tracing in the Apollo Router
description: Collect tracing information
---

import { Link } from "gatsby";

## Datadog (otlp)

To use Datadog, you must configure the Datadog agent to accept OTLP traces. This can be done by adding the following to your `datadog.yaml`:

```yaml title="datadog.yaml"
otlp_config:
  receiver:
    protocols:
      grpc:
        endpoint: <dd-agent-ip>:4317
```

The router must also be configured to send traces to the Datadog agent:

```yaml title="router.yaml"
telemetry:
  tracing:
    otlp:
      enabled: true

      # Optional endpoint, either 'default' or a URL (Defaults to http://127.0.0.1:4317)
      endpoint: "${env.DATADOG_AGENT_HOST}:4317"
```

See [Datadog Agent configuration](https://docs.datadoghq.com/opentelemetry/otlp_ingest_in_the_agent/?tab=host) for more details


## Using Datadog (native)

The Apollo Router can be configured to connect to either the default agent address or a URL.

```yaml title="router.yaml"
telemetry:
  tracing:
    datadog:
      enabled: true
      # Optional endpoint, either 'default' or a URL (Defaults to http://localhost:8126/v0.4/traces)
      endpoint: "http://${env.DATADOG_AGENT_HOST}:8126/v0.4/traces"
```

[Given that there are some incompatibilities](https://docs.rs/opentelemetry-datadog/latest/opentelemetry_datadog/#quirks)
between Datadog and OpenTelemetry, the DataDog exporter might not provide meaningful contextual information in the exported spans.
To fix this, you can configure the Apollo Router to perform a mapping for the span name and the span resource name.

```yaml title="router.yaml"
telemetry:
  tracing:
    datadog:
      enabled: true
      enable_span_mapping: true
```

when `enable_span_mapping` is set to `true`, the Apollo Router will perform the following mapping:

1. Use the Open Telemetry span name to set the Data Dog span operation name.
2. Use the Open Telemetry span attributes to set the DataDog span resource name.

Example:

Lets say we send a query `MyQuery` to the Apollo Router, then the Router using the operation's query plan will send a
query to `my-subgraph-name` and the following trace will be created:

```
    | apollo_router request                                                                 |
        | apollo_router router                                                              |
            | apollo_router supergraph                                                      |
            | apollo_router query_planning  | apollo_router execution                       |
                                                | apollo_router fetch                       |
                                                    | apollo_router subgraph                |
                                                        | apollo_router subgraph_request    |
```

As you can see, there is no clear information about the name of the query, the name of the subgraph, and the name of the
query sent to the subgraph.

Instead when `enable_span_mapping` is set to `true` the following trace will be created:

```
    | request /graphql                                                                                   |
        | router                                                                                         |
            | supergraph MyQuery                                                                         |
                | query_planning MyQuery  | execution                                                    |
                                              | fetch fetch                                              |
                                                  | subgraph my-subgraph-name                            |
                                                      | subgraph_request MyQuery__my-subgraph-name__0    |
```



