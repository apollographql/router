---
title: Response caching for private data for the GraphOS Router
description: Response caching for private data for GraphOS Router with GraphOS Enterprise.
minVersion: Router v2.8.0
releaseStage: preview
---

## Private information caching

A subgraph can return a response with the header `Cache-Control: private`, indicating that it contains user-personalized data. Although this usually forbids intermediate servers from storing data, the router may be able to recognize different users and store their data in different parts of the cache.

To set up private information caching, you can configure the `private_id` option. `private_id` is a string pointing at a field in the request context that contains data used to recognize users (for example, user id, or `sub` claim in JWT).

As an example, if you are using the router's JWT authentication plugin, first configure the <code>private_id</code> option in the <code>accounts</code> subgraph to point to the <code>user_id</code> key in the context. Then, use a Rhai script to set that key from the JWT's <code>sub</code> claim:

```yaml title="router.yaml"
preview_response_cache:
  enabled: true
  subgraph:
    all:
      enabled: true
      redis:
        urls: ["redis://..."]
    subgraphs:
      accounts:
        private_id: "user_id"
authentication:
  router:
    jwt:
      jwks:
        - url: https://auth-server/jwks.json
```

```rhai title="main.rhai"
fn supergraph_service(service) {
  let request_callback = |request| {
    let claims = request.context[Router.APOLLO_AUTHENTICATION_JWT_CLAIMS];

    if claims != () {
      let private_id = claims["sub"];
      request.context["user_id"] = private_id;
    }
  };

  service.map_request(request_callback);
}
```

The router implements the following sequence to determine whether a particular query returns private data:

- Upon seeing a query for the first time, the router requests the cache as if it were a public-only query.
- When the subgraph returns the response with private data, the router recognizes it and stores the data in a user-specific part of the cache.
- The router stores the query in a list of known queries with private data.
- When the router subsequently sees a known query:
  - If the private ID isn't provided, the router doesn't check the cache and instead transmits the subgraph response directly.
  - If the private id is provided, the router queries the part of the cache for the current user and checks the subgraph if nothing is available.
