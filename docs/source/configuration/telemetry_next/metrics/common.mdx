---
title: Collecting metrics in the Apollo Router
---

The Apollo Router provides built-in support for metrics collection via [Prometheus](#using-prometheus) and [OpenTelemetry Collector](#using-opentelemetry-collector).

## Common configuration

Metrics common configuration allow you to set:
* Service name
* Resource attributes
* Custom buckets for histogram metrics

### Service name

```yaml title="router.yaml"
telemetry:
  metrics:
    common:
      # (Optional) Set the service name to easily find metrics related to the apollo-router in your metrics dashboards
      service_name: "router"
```

Service name discovery is handled in the following order:
1. `OTEL_SERVICE_NAME` env
2. `OTEL_RESOURCE_ATTRIBUTES` env
3. `router.yaml` `service_name`
4. `router.yaml` `resource`

If none of the above are found then the service name will be set to `unknown_service:apollo_router` or `unknown_service` if the executable name cannot be determined.

### Resource

A Resource is a set of key-value pairs that provide additional information to an exporter. APMs may interpret and display resource information. 

```yaml title="router.yaml"
telemetry:
  metrics:
    common:
      resource:
        "environment.name": "production"
        "environment.namespace": "{env.MY_K8_NAMESPACE_ENV_VARIABLE}"
```

> [See OpenTelemetry conventions for resources.](https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/resource/semantic_conventions/README.md)


### Changing default buckets for histograms

You can customize the buckets for all generated histograms:

```yaml title="router.yaml"
telemetry:
  metrics:
    common:
      buckets:
        - 0.05
        - 0.10
        - 0.25
        - 0.50
        - 1.00
        - 2.50
        - 5.00
        - 10.00
        - 20.00
```


### Customizing `apollo_router_http_requests` instrument (deprecated)

> Note that this configuration is deprecated, and will be removed in a future release.

You can add custom attributes (OpenTelemetry) and labels (Prometheus) to the `apollo_router_http_requests` metric. Attributes can be static or obtained from requests or responses that are :
* static values (prefer using a resource)
* headers from the request or response.
* a value from context.
* a value from the request or response body ([JSON path](https://goessner.net/articles/JsonPath/)).

An example of configuring these attributes is shown below:

```yaml title="router.yaml"
telemetry:
  metrics:
    common:
      attributes:
        supergraph: # Attribute configuration for requests to/responses from the router
          static:
            - name: "version"
              value: "v1.0.0"
          request:
            header:
              - named: "content-type"
                rename: "payload_type"
                default: "application/json"
              - named: "x-custom-header-to-add"
          response:
            body:
              # Apply the value of the provided path of the router's response body as an attribute
              - path: .errors[0].extensions.http.status
                name: error_from_body
              # Use the unique extension code to identify the kind of error
              - path: .errors[0].extensions.code
                name: error_code
          context:
            # Apply the indicated element from the plugin chain's context as an attribute
            - named: my_key
        subgraph: # Attribute configuration for requests to/responses from subgraphs
          all:
            static:
              # Always apply this attribute to all metrics for all subgraphs
              - name: kind
                value: subgraph_request
            errors: # Only work if it's a valid GraphQL error (for example if the subgraph returns an http error or if the router can't reach the subgraph)
              include_messages: true # Will include the error message in a message attribute
              extensions: # Include extensions data
                - name: subgraph_error_extended_type # Name of the attribute
                  path: .type # JSON query path to fetch data from extensions
                - name: message
                  path: .reason
            # Will create this kind of metric for example apollo_router_http_requests_error_total{message="cannot contact the subgraph",subgraph="my_subgraph_name",subgraph_error_extended_type="SubrequestHttpError"}
          subgraphs:
            my_subgraph_name: # Apply these rules only for the subgraph named `my_subgraph_name`
              request:
                header:
                  - named: "x-custom-header"
                body:
                  # Apply the value of the provided path of the router's request body as an attribute (here it's the query)
                  - path: .query
                    name: query
                    default: UNKNOWN
```

Open telemetry includes many [standard attributes]()
