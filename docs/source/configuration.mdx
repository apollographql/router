---
title: Apollo Router usage and config
sidebar_title: Usage and config
---

import { Link } from "gatsby";

> For installation instructions, see the [quickstart](../quickstart/).

You run Apollo Router with the following command (assuming you're in the same directory as the `router` executable):

```bash
./router --config configuration.yaml --supergraph supergraph-schema.graphql
```

Options are described below.

## Options

<table class="field-table api-ref">
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>

<tbody>

<tr class="required">
<td>

##### `-s` / `--supergraph`

</td>
<td>

The absolute or relative path to the router's [supergraph schema](https://www.apollographql.com/docs/federation/#federated-schemas).

To learn how to compose your supergraph schema with the Rover CLI, see the [Federation quickstart](https://www.apollographql.com/docs/federation/quickstart/#3-compose-the-supergraph-schema).

**Required** unless you provide this value via the `SCHEMA_PATH` environment variable.

</td>
</tr>

<tr>
<td style="min-width: 150px;">

##### `-c` / `--config`

</td>
<td>

The absolute or relative path to the router's optional [YAML configuration file](#configuration-file).

You can also provide this value via the `CONFIGURATION_PATH` environment variable.

</td>
</tr>

<tr>
<td style="min-width: 150px;">

##### `--log`

</td>
<td>

The log level, which can be one of: `off`, `error`, `warn`, `info`, `debug`, or `trace`.

Default: `info`

</td>
</tr>

</tbody>
</table>

## Handling CORS

If you attempt to query the Apollo Router from a browser-based client, your request might be rejected due to CORS policies.

You can configure CORS in the [YAML configuration file](#configuration-file) you provide to the Apollo Router.

Here's an example configuration for adding `localhost` to the list of approved origins:

```yaml
# examples/nodejs/configuration.yaml
server:
  listen: 127.0.0.1:4000
  cors:
    origins:
      - https://studio.apollographql.com
      - http://localhost
```

## Logging

The Apollo Router automatically uses JSON-formatted logging when there is not an interactive shell session attached (e.g., in CI and deployed environments). JSON-formatted logging facilitates compatibility with searchable logging facilities like Google Cloud Logging or Stackdriver.

## Configuration file

Apollo Router takes an optional YAML configuration file as input via the `--config` option. All supported configuration options are shown below:

```yaml:title=configuration.yaml
#
# The Apollo Router doesn't require a configuration file to run. This
# example is a verbose representation of possible configuration. It's
# more of an "everything and the kitchen sink" of potential configuration
# rather than any recommendation.
#

#
# server: Configuration of the HTTP server
#
server:
  # The socket address and port to listen on
  # Defaults to 127.0.0.1:4000
  listen: 127.0.0.1:4000

  #
  # CORS (Cross Origin Resource Sharing)
  #
  cors:
    # Set to false to disallow any origin and rely exclusively on `origins`
    # Defaults to true
    allow_any_origin: true
    # List of accepted origins
    origins:
      - https://studio.apollographql.com
    # Set to true to add the `Access-Control-Allow-Credentials` header
    allow_credentials: false
    # The headers to allow.
    # Defaults to the required request header for Apollo Studio: Content-Type
    allow_headers: [ Content-Type ]
    # Allowed request methods
    # Defaults to GET, POST, OPTIONS.
    methods: [ GET, POST, OPTIONS ]
    # Which response headers should be made available to scripts running in the
    # browser in response to a cross-origin request.
    expose_headers:

#
# Subgraphs
#
# This configuration affects the communication with underlying subgraphs.
# The `subgraphs` property is a map to individual named subgraphs and should
# map to the subgraph name that is defined in the Supergraph.
#
# On each named subgraph of the subgraphs map, these properties can be set:
#
#  - routing_url
#  - layers
#
# These are explained further below.
#
# * routing_url *
#
# The URL the Router should connect to for this subgraph.
#
# By default, routing information is parsed from the supergraph which is
# typically sufficient for most environments and respects the settings which
# you've set during composition in Apollo Studio or via Rover.  Provide it here
# only to *override* the supergraph's subgraph routing URLs.
#
#
# * layers *
#
# This is a map of configurable layers which will be invoked.
#
# Layers are features (either native or extensions) which can be enabled for
# each subgraph.  Common layers are the "headers*" layers, and an example can be
# found for below.  For more information, see later in the documentation.
#

subgraphs:
  # Specifies the runtime configuration for talking to the "accounts" subgraph.
  accounts:
    # The URL of the "accounts" subgraph's GraphQL endpoint
    routing_url: http://localhost:4001/graphql

    # Layers to be applied to the "accounts" subgraph.
    layers:
      - headers_propagate:
          matching:
            regex: ^upstream-header-.*
      - headers_propagate:
          named:
            name: "old-name"
            rename: "new-name"
            default_value: "0"
      - headers_propagate:
          named:
            name: "old-name"
            rename: "new-name"
            default_value: "0"
      - headers_remove:
          name: "x-legacy-account-id"
      - headers_remove:
          matching:
            regex: ^x-deprecated.*
      - headers_insert:
          name: "router-subgraph-name"
          value: "accounts"

  # Specifies the runtime configuration for talking to the "products" subgraph.
  products:
    # The URL of the "products" subgraph's GraphQL endpoint
    routing_url: http://localhost:4003/graphql

    # Layers to be applied to the "products" subgraph.
    layers:
      - headers_insert:
          name: "router-subgraph-name"
          value: "products"
      - headers_remove:
          name: "x-legacy-tracking-id"


# graph configuration, see documentation below
# graph:

# spaceport configuration, see documentation below
# spaceport:

# OpenTelemetry configuration, see documentation below
# opentelemetry:
```

## Passing headers to subgraphs

You can customize which HTTP headers the Apollo Router includes in its requests to your individual subgraphs. You specify these headers on a per-subgraph basis in your [YAML configuration file](#configuration-file).

More specifically, each subgraph's configuration includes a `layers` array that can include header-related actions for the router to perform (in order) before sending a request:

```yaml{4-12}
products:
  # ...other configuration...

  layers:
    - headers_propagate:
        matching:
          regex: ^upstream-header-.*
    - headers_remove:
        name: "x-legacy-account-id"
    - headers_insert:
        name: "router-subgraph-name"
        value: "accounts"
```

The following transformations are specific to customizing headers sent to subgraphs:

### `headers_propagate`

Enables you to selectively propagate headers that were included in the client's request to the router.

> **Note:** The Router _never_ propagates so-called [hop-by-hop headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers#hop-by-hop_headers), such as `Content-Length`.

You can specify which headers to propagate based on a matching [regex pattern](https://docs.rs/regex/latest/regex/):

```yaml
- headers_propagate:
    matching:
      regex: .*
```

You can also provide a static string with the `named` option. These `named` configurations have additional flexibility, because they support the following options:

- `default_value`: A value to set if _no_ value was sent by the client
- `rename`: Renames the header's key to the provided value

```yaml
- headers_propagate:
    named:
      name: "x-user-id"
      default_value: "abc123"
      rename: "account-id"
    named:
      name: "Authorization"
```

### `headers_remove`

Enables you to selectively remove headers that were included in the client's request to the router. Similar to [`headers_propagate`](#headers-propagate), this option can match either a static string or a [regular expression](https://docs.rs/regex/latest/regex/).

> **Note:** The Router _never_ propagates so-called [hop-by-hop headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers#hop-by-hop_headers), such as `Content-Length`.

```yaml
# Do not send this subgraph the "Cookie" header.
- headers_remove:
    name: "Cookie"
- headers_remove:
    matching:
      # Remove headers that include the legacy 'x-' prefix.
      regex: ^x-.*$
```

### `headers_insert`

Enables you to add custom headers to requests going to a specific subgraph. These headers are always static strings that originate in the router, instead of originating in the client.

```yaml
- headers_insert:
    name: "sent-from-our-apollo-router"
    value: "indeed"
```

### Example

Here's an example of customizing different headers for two subgraphs: `accounts` and `products`. These two subgraphs are both sent `router-subgraph-name` headers with either the `accounts` or `products` value, respectively. Any other subgraph receives _no_ headers.

```yaml
subgraphs:
  # These headers apply to the "accounts" subgraph only.
  # They are not passed to the "products" subgraph (below).
  accounts:
    layers:
      - headers_insert:
          name: "router-subgraph-name"
          value: "accounts"
  products:
    # Layers to be applied to the "products" subgraph only.
    # They are not passed to the "accounts" subgraph (above).
    layers:
      - headers_insert:
          name: "router-subgraph-name"
          value: "products"
```

## OpenTelemetry tracing

The Apollo Router supports [OpenTelemetry](https://opentelemetry.io/), with exporters for [Jaeger](https://www.jaegertracing.io/) and the [OpenTelemetry Protocol (OTLP)](https://aws-otel.github.io/docs/components/otlp-exporter) over HTTP or gRPC. The router generates traces that include the various phases of executing a GraphQL operation and associated dependencies.

The router sends a `TraceParent` header to subgraphs so they can create and send their own spans under the same trace.

If the router receives an incoming request that already contains a `TraceParent` header, it uses that header's trace ID instead of generating a random one.

### Using Jaeger

```yaml:title=configuration.yaml
server:
  listen: 127.0.0.1:4000
apollo.reporting:
  # Optional if you want to enable opentracing propagation headers to your subgraphs
  # opentracing:
    # "zipkin_b3" and "jaeger" formats are supported
    # format: "zipkin_b3"
  jaeger:
    # optional: if not present, jaeger will use the default UDP agent address
    #endpoint:
      # address for the UDP agent mode
      # incomptable with collector
      # agent: "127.0.0.1:1234"

      # URL of the HTTP collector
      # collector:" http://example.org"
      # the username and password are obtained from the environment variables
      # JAEGER_USERNAME and JAEGER_PASSWORD

    # name of the service used in traces
    # defaults to router
    service_name: "router"

    trace_config:
      # trace sampling: possible values are `AlwaysOn`, `AlwaysOff`, or
      # `TraceIdRatioBased: number`. The ratio sampler takes a value between 0
      # and 1 and decides on trace creation whether it will be recorded.
      sampler:
        TraceIdRatioBased: 0.42
      max_events_per_span: 1
      max_attributes_per_span: 2
      max_links_per_span: 3
      max_attributes_per_event: 4
      max_attributes_per_link: 5
      resource:
        attrs:
          key1:
            String: value
          key2:
            Bool: true
          key3:
            I64: 42
          key4:
            F64: 42.0
          key5:
            Array:
              String:
                - value1
                - value2
```

### Using OTLP

```yaml:title=configuration.yaml
server:
  listen: 127.0.0.1:4000
apollo.reporting:
  # Optional if you want to enable opentracing propagation headers to your subgraphs
  # opentracing:
    # "zipkin_b3" and "jaeger" formats are supported
    # format: "zipkin_b3"
  # Configuration to send traces and metrics to an OpenTelemetry Protocol compatible service
  otlp:
    tracing:
      exporter:
        # 'http' for OTLP/HTTP, 'grpc' for OTLP/gRPC
        http:
          # URL of the exporter
          endpoint:
          # Possible options: 'Grpc' for GRPC protocol and 'HttpBinary' for HTTP protocol with binary protobuf
          protocol: Grpc
          # timmeout in seconds
          timeout: 60
          metadata:
            - foo: bar
      trace_config:
        # trace sampling: possible values are `AlwaysOn`, `AlwaysOff`, or
        # `TraceIdRatioBased: number`. The ratio sampler takes a value between 0
        # and 1 and decides on trace creation whether it will be recorded.
        sampler:
          TraceIdRatioBased: 0.42
        max_events_per_span: 1
        max_attributes_per_span: 2
        max_links_per_span: 3
        max_attributes_per_event: 4
        max_attributes_per_link: 5
        resource:
          attrs:
            key1:
              String: value
            key2:
              Bool: true
            key3:
              I64: 42
            key4:
              F64: 42.0
            key5:
              Array:
                String:
                  - value1
                  - value2
```

## Configuring managed federation

See [Managed federation with the Apollo Router](/managed-federation/).
