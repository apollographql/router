# Writing tests with subgraphs replaced by fixed mock data

When testing the Router, spinning up subgraph servers can be more involved than we’d like.
`apollo_router::test_harness::MockedSubgraphs` has long allowed tests to run a modified router
that intercepts subgraph requests and respond with fixed JSON data.
It is configured with a map of expected requests to corresponding responses.
For example:

```rust
// Don’t do this going forward! See below

let subgraphs = MockedSubgraphs([
    (
        "subgraph_name",
        MockSubgraph::builder()
        .with_json(
            serde_json::json!({
                "query": "query($representations:[_Any!]!){_entities(representations:$representations){...on Contact{__typename country}}}",
                "variables": {
                    "representations": [
                        {
                            "__typename":"Contact",
                            "id":"0",
                            "displayName": "Max",
                        }
                    ]
                }
            }),
            serde_json::json!({"data": {
                "_entities": [{
                    "__typename":"Contact",
                    "country": "Fr"
                }]
            }})
        ).with_json(
            serde_json::json!({
                "query": "query($representations:[_Any!]!){_entities(representations:$representations){...on Contact{country}}}",
                "variables": {
                    "representations": [
                        {
                            "__typename":"Contact",
                            "id":"0",
                            "displayName": "Max",
                        }
                    ]
                }
            }),
            serde_json::json!({"data": {
                "_entities": [{
                    "country": "Fr"
                }]
            }})
        ).build(),
    )
].collect());

let service = TestHarness::builder()
    .configuration_json(serde_json::json!({
        "include_subgraph_errors": { "all": true },
    }))
    .unwrap()
    .schema(SOME_TESTING_SCHEMA)
    .extra_plugin(subgraphs)
    .build_supergraph()
    .await
    .unwrap();
```

The map keys contain the `query` strings of subgraph requests generated by the query planner,
which can be hard to predict.

Instead, the comparatively newer `mock_subgraphs` is a built-in plugin
based on a full-featured GraphQL executor.
There is no need configure expected requests as the executor should be able to handle any request.
Only the data for responses need to be configured, and a request’s selection set can select
any subset of it.

```rust
// Recommended:

let subgraphs = serde_json::json!({
    "subgraph_name": {
        "entities": [
            {
                "__typename": "Contact",
                "id": "0",
                "displayName": "Max",
                "country": "Fr",
            },
        ],
    },
});

let service = TestHarness::builder()
    .configuration_json(serde_json::json!({
        "include_subgraph_errors": { "all": true },
        "experimental_mock_subgraphs": subgraphs,
    }))
    .unwrap()
    .schema(SOME_TESTING_SCHEMA)
    .build_supergraph()
    .await
    .unwrap();
```

Compared to before, note the additional `configuration_json` line and the lack of `extra_plugin`.

The full plugin configuration simplifies to:

```rust
type MockSubgraphPluginConfig = Map<SubgraphName, ConfigForOneSubgraph>;
type SubgraphName = String;

struct ConfigForOneSubgraph {
    /// Entities that can be queried through Federation’s special `_entities` field
    entities: Vec<JsonMap>,
    /// Data for `query` operations (excluding the special `_entities` field)
    query: JsonMap,
    /// Data for `mutation` operations
    mutation: Option<JsonMap>,
    /// HTTP headers for the subgraph response
    headers: Map<String, String>,
}
```

As of this writing, this plugin is only intended for the Router’s own tests but is always available.
It is excluded from the JSON Schema for Router configuration (see `HIDDEN_FROM_CONFIG_JSON_SCHEMA`)
and prefixed `experimental_`, but nothing actually prevents its use externally.

The plugin implementation lives at `apollo-router/src/plugins/mock_subgraphs/mod.rs`.
