---
# Drill configuration for load testing Apollo Router at 5 RPS for 10 minutes
concurrency: 1
base: 'http://localhost:4000'
iterations: 3000  # 5 requests/second * 600 seconds = 3000 total requests
rampup: 60        # Ramp up over 60 seconds to reach target rate

plan:
  - name: GraphQL Query Test
    request:
      url: /
      method: POST
      headers:
        Content-Type: application/json
        Accept: application/json
      body: |
        {
          "query": "query GetTopProducts($first: Int) { topProducts(first: $first) { upc name price weight } }",
          "variables": { "first": 5 }
        }
    assign:
      - response_time: "{{responseTime}}"
    
  - name: Introspection Query
    weight: 10  # Less frequent introspection queries  
    request:
      url: /
      method: POST  
      headers:
        Content-Type: application/json
        Accept: application/json
      body: |
        {
          "query": "query IntrospectionQuery { __schema { types { name } } }"
        }
    assign:
      - response_time: "{{responseTime}}"

# Rate limiting to achieve 5 RPS
delay:
  - 200ms  # 200ms delay between requests = 5 requests per second

# Reporting and assertions
stats: true
threshold:
  - "response_time < 1000"  # Response time should be under 1 second
  - "status == 200"         # All requests should return 200 OK