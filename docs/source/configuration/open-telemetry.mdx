---
title: OpenTelemetry
---

## OpenTelemetry

The Apollo Router supports [OpenTelemetry](https://opentelemetry.io/), with exporters for:
* [Jaeger](https://www.jaegertracing.io/)
* [OpenTelemetry Protocol (OTLP)](https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/protocol/otlp.md) over HTTP or gRPC.

The Apollo Router generates spans that include the various phases of serving a request and associated dependencies. 
This is useful for showing how response time is affected by:
* Sub-request response times.
* Query shape (sub-request dependencies).
* Apollo Router post-processing.

Span data is sent to a collector such as [Jaeger](https://www.jaegertracing.io/) can assemble spans into a gaant chart for analysis.

To get maximum benefit from distributed-tracing, all components in your system should be instrumented.

### Opentracing support
Although OpenTelemetry has superseded OpenTracing, you may need to interact with systems that have not yet moved to
OpenTelemetry. 

If you are using OpenTelemetry throughout your systems and just want to view in [Jaeger](https://www.jaegertracing.io/) 
you don't need to configure this.  

```yaml title="config.router.yaml" 
# ...other configuration...

telemetry:
  # Optional if you want to enable opentracing propagation headers to your subgraphs
  opentracing:
    # "zipkin_b3" and "jaeger" formats are supported
    format: "zipkin_b3"
   
  # ...other telemetry configuration...
```

### Using Jaeger
The Apollo Router can be configured to export tracing data to Jaeger either via an agent or http collector.

```yaml title="config.router.yaml"
telemetry:
  opentelemetry:
    jaeger:
      # Optional: if not present, jaeger will use the default UDP agent address
      #endpoint:
        # address for the UDP agent mode
        # incomptable with collector
        # agent: "127.0.0.1:1234"

        # URL of the HTTP collector
        # collector:" http://example.org"
        # the username and password are obtained from the environment variables
        # JAEGER_USERNAME and JAEGER_PASSWORD

      # Name of the service used in traces
      # defaults to router
      service_name: "router"

      trace_config:
        # trace sampling: possible values are `AlwaysOn`, `AlwaysOff`, or
        # `TraceIdRatioBased: number`. The ratio sampler takes a value between 0
        # and 1 and decides on trace creation whether it will be recorded.
        sampler:
          TraceIdRatioBased: 0.42
        max_events_per_span: 1
        max_attributes_per_span: 2
        max_links_per_span: 3
        max_attributes_per_event: 4
        max_attributes_per_link: 5
        resource:
          attrs:
            key1:
              String: value
            key2:
              Bool: true
            key3:
              I64: 42
            key4:
              F64: 42.0
            key5:
              Array:
                String:
                  - value1
                  - value2
```

### OpenTelemetry Collector via OTLP
[OpenTelemetry Collector](https://opentelemetry.io/docs/collector/) is a horizontally scalable collector that can be 
used to receive, process and export your telemetry data in a pluggable way. 

If you find that the built-in telemetry 
features of the Apollo Router are missing some desired functionality e.g. [exporting to Kafka](https://opentelemetry.io/docs/collector/configuration/#exporters)
then it's worth considering this option.

```yaml title="config.router.yaml"
telemetry:
  # Configuration to send traces and metrics to an OpenTelemetry Protocol compatible service
  opentelemetry:
    otlp:
      tracing:
        exporter:
          # 'http' for OTLP/HTTP, 'grpc' for OTLP/gRPC
          http:
            # URL of the exporter
            endpoint: http://example.com
            # Possible options: 'Grpc' for GRPC protocol and 'HttpBinary' for HTTP protocol with binary protobuf
            protocol: Grpc
            # timmeout in seconds
            timeout: 60
        trace_config:
          # trace sampling: possible values are `AlwaysOn`, `AlwaysOff`, or
          # `TraceIdRatioBased: number`. The ratio sampler takes a value between 0
          # and 1 and decides on trace creation whether it will be recorded.
          sampler:
            TraceIdRatioBased: 0.42
          max_events_per_span: 1
          max_attributes_per_span: 2
          max_links_per_span: 3
          max_attributes_per_event: 4
          max_attributes_per_link: 5
          resource:
            attrs:
              key1:
                String: value
              key2:
                Bool: true
              key3:
                I64: 42
              key4:
                F64: 42.0
              key5:
                Array:
                  String:
                    - value1
                    - value2
```
