---
title: Traffic shaping in the Apollo Router
---

The Apollo Router provides support for traffic shaping.

Currently features are limited, but are expected to grow over time:

- **Sub-query deduplication** - Identical, in-flight, non-mutation sub-queries are compressed into a single request.
- **Variables deduplication** - Subgraph requests body is compressed to deduplicate variables.
- **Compression** - Subgraph requests body and responses body are compressed in the specified compression algorithm (`gzip`, `br`, `deflate`).

## Configuration

To enable traffic shaping, add the `traffic_shaping` plugin to your [YAML config file](./configuration/#yaml-config-file), like so:

```yaml title="router.yaml"
traffic_shaping:
  variables_deduplication: true # Enable the variable deduplication optimization.
  all:
    query_deduplication: true # Enable query deduplication for all subgraphs.
    compression: br # Enable brotli compression for all subgraphs.
  subgraphs:
    products:
      query_deduplication: false # Disable query for the products subgraph.
      compression: gzip # Enable gzip compression only for the products subgraph.
```

Any configuration under the `subgraphs` key takes precedence over configuration under the `all` key. In the example above, query deduplication is enabled for all subgraphs _except_ the `products` subgraph.

### Sub-query deduplication

Deduplication causes any identical, in-flight, non-mutation sub-queries to be merged into a single request. This can reduce network bandwidth and CPU usage in your subgraph.

Note that only in-flight requests are deduplicated.

### Variable deduplication

Variables deduplication will cause any identical variables in the sub-request body to be merged into an unique list of variables. This can reduce network bandwidth and CPU at your subgraph.

### Compression

You can enable compression on subgraph requests and responses. Available compression algorithms are: `gzip`, `br`, `deflate`.
