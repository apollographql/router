---
title: Apollo Router usage and config
sidebar_title: ⚙️ Usage and config
---

> For installation instructions, see the [quickstart](../quickstart/).

You run Apollo Router with the following command (assuming you're in the same directory as the `router` executable):

```bash
./router --config configuration.yaml --supergraph supergraph-schema.graphql
```

Options are described below.

## Options

<table class="field-table api-ref">
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
    </tr>
  </thead>

<tbody>

<tr class="required">
<td>

##### `-s` / `--supergraph`

</td>
<td>

The absolute or relative path to the router's [supergraph schema](https://www.apollographql.com/docs/federation/#federated-schemas).

To learn how to compose your supergraph schema with the Rover CLI, see the [Federation quickstart](https://www.apollographql.com/docs/federation/quickstart/#3-compose-the-supergraph-schema).

**Required** unless you provide this value via the `SCHEMA_PATH` environment variable.

</td>
</tr>

<tr>
<td style="min-width: 150px;">

##### `-c` / `--config`

</td>
<td>

The absolute or relative path to the router's optional [YAML configuration file](#configuration-file).

You can also provide this value via the `CONFIGURATION_PATH` environment variable.

</td>
</tr>

<tr>
<td style="min-width: 150px;">

##### `--log`

</td>
<td>

Log level which may be one of: `off`, `error`, `warn`, `info`, `debug`, or `trace`.

Default: `info`

</td>
</tr>

</tbody>
</table>

## Handling CORS

If you attempt to query Apollo Router from a browser-based client, your request might be rejected due to CORS policies.

You can configure CORS in the [YAML configuration file](#configuration-file) you can provide to Apollo Router.

Here's an example configuration for adding `localhost` to the list of approved origins:

```yaml
# examples/nodejs/configuration.yaml
server:
  listen: 127.0.0.1:4000
  cors:
    origins:
      - https://studio.apollographql.com
      - http://localhost
```

## Logging

Apollo Router detects if the stdout is a TTY and enables JSON logging only if it is not.

## Configuration file

Apollo Router takes an optional YAML configuration file as input via the `--config` option. All supported configuration options are listed below:

```yaml:title=configuration.yaml
# Configuration of the router's HTTP server
server:
  # The socket address and port to listen on
  # Defaults to 127.0.0.1:4000
  listen: 127.0.0.1:4000

  # Cross origin request headers
  cors:
    # Set to false to disallow any origin and rely exclusively on `origins`
    # Defaults to true
    allow_any_origin: true
    # List of accepted origins
    origins:
      - https://studio.apollographql.com
    # Set to true to add the `Access-Control-Allow-Credentials` header
    allow_credentials: false
    # The headers to allow.
    # Defaults to the required request header for Apollo Studio: Content-Type
    allow_headers: [ Content-Type ]
    # Allowed request methods
    # Defaults to GET, POST, OPTIONS.
    methods: [ GET, POST, OPTIONS ]
    # Which response headers should be made available to scripts running in the browser,
    # in response to a cross-origin request.
    expose_headers:

# Names and URLs of all subgraphs
# By default, this information is parsed from the supergraph schema
# Provide it here to override subgraph names or URLs
subgraphs:
  # Defines a subgraph named "accounts"
  accounts:
    # The URL of the accounts subgraph's GraphQL endpoint
    routing_url: http://localhost:4001/graphql
  # Defines a second subgraph named "products"
  products:
    routing_url: http://localhost:4003/graphql

# graph configuration, see later section
# graph:

# spaceport configuration, see later section
# spaceport:

# OpenTelemetry configuration, see next section
# opentelemetry:
```

## Tracing

The Apollo Router supports [OpenTelemetry](https://opentelemetry.io/), it has exporters for [Jaeger](https://www.jaegertracing.io/) and for the [OpenTelemetry Protocol (OTLP)](https://aws-otel.github.io/docs/components/otlp-exporter) over HTTP or gRPC.
It will generate a trace of the various phases of the GraphQL query and their dependencies.

It will send a `TraceParent` header to subgraphs so they can create and send their own spans under the same trace.
If the request to the Router already contains a `TraceParent` header, it will use its value as trace id instead of generating a random one.

### Using Jaeger

```yaml:title=configuration.yaml
server:
  listen: 127.0.0.1:4000
opentelemetry:
  jaeger:
    # optional: if not present, jaeger will use the default UDP agent address
    #endpoint:
      # address for the UDP agent mode
      # incomptable with collector
      # agent: "127.0.0.1:1234"

      # URL of the HTTP collector
      # collector:" http://example.org"
      # the username and password are obtained from the environment variables
      # JAEGER_USERNAME and JAEGER_PASSWORD

    # name of the service used in traces
    # defaults to router
    service_name: "router"
    
    trace_config:
      # trace sampling, possible values are `AlwaysOn`, `AlwaysOff` or `TraceIdRatioBased: number`
      # the ratio sampler takes a value between 0 and 1 and decides at the trace creation if it will
      # be recorded or not
      sampler:
        TraceIdRatioBased: 0.42
      max_events_per_span: 1
      max_attributes_per_span: 2
      max_links_per_span: 3
      max_attributes_per_event: 4
      max_attributes_per_link: 5
      resource:
        attrs:
          key1:
            String: value
          key2:
            Bool: true
          key3:
            I64: 42
          key4:
            F64: 42.0
          key5:
            Array:
              String:
                - value1
                - value2
```

### Using OTLP


```yaml:title=configuration.yaml
server:
  listen: 127.0.0.1:4000
opentelemetry:
  # Configuration to send traces and metrics to an OpenTelemetry Protocol compatible service
  otlp:
    tracing:
      exporter:
        # 'http' for OTLP/HTTP, 'grpc' for OTLP/gRPC
        http:
          # URL of the exporter
          endpoint:
          # Possible options: 'Grpc' for GRPC protocol and 'HttpBinary' for HTTP protocol with binary protobuf
          protocol: Grpc
          # timmeout in seconds
          timeout: 60
          metadata:
            - foo: bar
      trace_config:
        # trace sampling, possible values are `AlwaysOn`, `AlwaysOff` or `TraceIdRatioBased: number`
        # the ratio sampler takes a value between 0 and 1 and decides at the trace creation if it will
        # be recorded or not
        sampler:
          TraceIdRatioBased: 0.42
        max_events_per_span: 1
        max_attributes_per_span: 2
        max_links_per_span: 3
        max_attributes_per_event: 4
        max_attributes_per_link: 5
        resource:
          attrs:
            key1:
              String: value
            key2:
              Bool: true
            key3:
              I64: 42
            key4:
              F64: 42.0
            key5:
              Array:
                String:
                  - value1
                  - value2
```

## Spaceport

Spaceport reports usage data to the Apollo ingress. You can see how it is configured in the examples above.

NB: This component is still evolving and you should expect functionality to change and evolve here. We are actively seeking user feedback as we work to shape this component.

### No usage reporting

If you don't wish to take advantage of usage reporting, then no configuration is required. This is the default.

### Usage reporting

```yaml:title=configuration.yaml
# Apollo Studio Graph configuration details
# If we don't specify a graph section, then no statistics are collected for
# processing, since there is no point collecting statistics unless we have
# somewhere to send them.
graph:
  # Which graph should our Spaceport be sending data about?
  reference: Benchmarking@current
  # Key used to send data
  key: service:<redacted>
```

You must configure the graph section. If you specify a graph section, then both the reference and the key must be specified. The reference must refer to a valid graph/version combination against which statistics are reported. The Key must be a valid API key which can be used for reporting statistics.
For more details on this process, refer to the [usage reporting documentation](https://www.apollographql.com/docs/studio/metrics/usage-reporting/)
The key fulfills the same function as the APOLLO_KEY environment variable.
The reference fulfills the same function as the APOLLO_GRAPH_REF environment variable.
NB: These environment variables are *not* currently recognised by the router. This is being tracked by [issue](https://github.com/apollographql/router/issues/425)

### Spaceport Configuration

The spaceport can either be run as an internal, router specific component or as an external resource shared by multiple routers.

```yaml:title=configuration.yaml
# Spaceport configuration. These values are the default values if not specified
spaceport:
  # Should we spawn a Spaceport or talk to an existing external Spaceport?
  external: false
  # What's the address of the Spaceport?
  collector: https://127.0.0.1:50051
  # Where should we listen IF we have spawned an internal Spaceport?
  listener: 0.0.0.0:50051
```

#### Internal Spaceport

This is the default and is most appropriate for evaluations, demos, development support and generally getting started. This requires no configuration by default and will be automatically started if the graph configuration is present.
In this mode it is possible to further configure the address at which the internal spaceport is listening and the address of the spaceport to use. This should only be necessary if there is a clash on the default port, for instance if running multiple routers on the same system or clashing with another application.

#### External Spaceport

In this case, external is true, the router will not start an internal spaceport task but will attempt to connect to an external process at the specified listener address. This mode of operation is intended for production environments where, for example, configuration of sensitive key data or allocation of reporting resources, can be centralised and tightly controlled. The listener parameter is ignored for an external spaceport. The collector parameter specifies the address of the shared spaceport.

