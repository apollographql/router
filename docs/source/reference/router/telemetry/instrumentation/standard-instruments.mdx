---
title: Router Instruments
subtitle: Standard metric instruments for the router's request lifecycle
description: Reference of standard metric instruments for the request lifecycle of GraphOS Router and Apollo Router Core. Consumable via the router's metrics exporters. 
---

## Standard metric instruments

GraphOS Router and Apollo Router Core provide a set of non-configurable metric instruments that expose detailed information about the router's request lifecycle.

These instruments can be consumed by configuring a [metrics exporter](/router/configuration/telemetry/exporters/metrics/overview).

### HTTP

- `apollo_router_http_request_duration_seconds_bucket` - HTTP router request duration
- `apollo_router_http_request_duration_seconds_bucket` - HTTP subgraph request duration, attributes:
  - `subgraph`: (Optional) The subgraph being queried
- `apollo_router_http_requests_total` - Total number of HTTP requests by HTTP status
- `apollo_router_http_request_retry_total` - Number of subgraph requests retried, attributes:
  - `subgraph`: The subgraph being queried
  - `status` : If the retry was aborted (`aborted`)

- `apollo.router.graphql_error` - counts GraphQL errors in responses, attributes:
  - `code`: error code

### Session

- `apollo_router_session_count_total` - Number of currently connected clients
- `apollo_router_session_count_active` - Number of in-flight GraphQL requests

### Cache

- `apollo_router_cache_size` â€” Number of entries in the cache
- `apollo_router_cache_hit_count` - Number of cache hits
- `apollo_router_cache_miss_count` - Number of cache misses
- `apollo_router_cache_hit_time` - Time to hit the cache in seconds
- `apollo_router_cache_miss_time` - Time to miss the cache in seconds
- `apollo.router.cache.storage.estimated_size` - The estimated storage size of the cache in bytes (query planner in memory only).

All cache metrics listed above have the following attributes:

- `kind`: the cache being queried (`apq`, `query planner`, `introspection`)
- `storage`: The backend storage of the cache (`memory`, `redis`)

### Coprocessor

- `apollo_router_operations_coprocessor_total` - Total operations with coprocessors enabled.
- `apollo_router_operations_coprocessor.duration` - Time spent waiting for the coprocessor to answer, in seconds.

The coprocessor operations metric has the following attributes:

- `coprocessor.stage`: string (`RouterRequest`, `RouterResponse`, `SubgraphRequest`, `SubgraphResponse`)
- `coprocessor.succeeded`: bool

### Performance

- `apollo_router_processing_time` - Time spent processing a request (outside of waiting for external or subgraph requests) in seconds.
- `apollo_router_schema_load_duration` - Time spent loading the schema in seconds.

### Query planning

- `apollo_router.query_planning.warmup.duration` - Time spent warming up the query planner queries in seconds.
- `apollo.router.query_planning.plan.duration` - Histogram of plan durations isolated to query planning time only.
- `apollo.router.query_planning.total.duration` - Histogram of plan durations including queue time.
- `apollo.router.query_planning.queued` - When the legacy planner is used, a gauge of the number of queued plans requests.
- `apollo.router.query_planning.plan.evaluated_plans` - Histogram of the number of evaluated query plans.
- `apollo.router.v8.heap.used` - heap memory used by V8, in bytes.
- `apollo.router.v8.heap.total` - total heap allocated by V8, in bytes.

### Compute jobs

- `apollo.router.compute_jobs.queued` - A gauge of the number of jobs queued for the thread pool dedicated to CPU-heavy components like GraphQL parsing and validation, and the (new) query planner.

### Uplink

<Tip>

[Learn more about Apollo Uplink.](/federation/managed-federation/uplink/)

</Tip>

- `apollo_router_uplink_fetch_duration_seconds` - Uplink request duration, attributes:
  - `url`: The Uplink URL that was polled
  - `query`: The query that the router sent to Uplink (`SupergraphSdl` or `License`)
  - `kind`: (`new`, `unchanged`, `http_error`, `uplink_error`)
  - `code`: The error code depending on type (if an error occurred)
  - `error`: The error message (if an error occurred)
- `apollo_router_uplink_fetch_count_total`
  - `status`: (`success`, `failure`)
  - `query`: The query that the router sent to Uplink (`SupergraphSdl` or `License`)

<Note>

The initial call to Uplink during router startup is not reflected in metrics.

</Note>

### Subscriptions

<Tip>

[Learn more about subscriptions.](/router/executing-operations/subscription-support/)

</Tip>

- `apollo_router_opened_subscriptions` - Number of different opened subscriptions (not the number of clients with an opened subscriptions in case it's deduplicated)
- `apollo_router_deduplicated_subscriptions_total` - Number of subscriptions that has been deduplicated
- `apollo_router_skipped_event_count` - Number of subscription events that has been skipped because too many events have been received from the subgraph but not yet sent to the client.

### Batching

- `apollo.router.operations.batching` - A counter of the number of query batches received by the router.
- `apollo.router.operations.batching.size` - A histogram tracking the number of queries contained within a query batch.

### GraphOS Studio

- `apollo.router.telemetry.studio.reports` - The number of reports submitted to GraphOS Studio by the router.
  - `report.type`: The type of report submitted: "traces" or "metrics"
  - `report.protocol`: Either "apollo" or "otlp", depending on the experimental_otlp_tracing_sampler configuration.

### Deprecated

The following metrics have been deprecated and should not be used.

- `apollo_router_span` - **Deprecated**: use `apollo_router_processing_time` instead.
- `apollo_router_deduplicated_subscriptions_total` - **Deprecated**: use the `apollo.router.operations.subscriptions` metric's `subscriptions.deduplicated` attribute.
- `apollo_authentication_failure_count` - **Deprecated**: use the `apollo.router.operations.authentication.jwt` metric's `authentication.jwt.failed` attribute.
- `apollo_authentication_success_count` - **Deprecated**: use the `apollo.router.operations.authentication.jwt` metric instead. If the `authentication.jwt.failed` attribute is *absent* or `false`, the authentication succeeded.
- `apollo_require_authentication_failure_count` - **Deprecated**: TODO @goto-bus-stop: no replacement?
- `apollo_router_timeout` - **Deprecated**: this metric conflates timed-out requests from client to the router, and requests from the router to subgraphs. See [migration instructions](#migrating-from-apollo_router_timeout).
- `apollo.router.graphql_error`- **Deprecated**: this metric can significantly overcount errors and is not correlated with particular requests. See [migration instructions](#migrating-from-apollo-router-graphql_error).

#### Migrating from `apollo_router_timeout`

Reporting timed-out requests can be done with a [custom instrumentation] attribute. This will report router request timeouts and subgraph request timeouts separately.

```yaml title="router.yaml"
telemetry:
  instrumentation:
    instruments:
      router:
        http.server.request.duration:
          # Adding response status code from the router
          attributes:
            # If status code == 504 then the router HTTP request timed out.
            http.response.status_code: true
      subgraph:
        # Adding subgraph name & response status code from the subgraph
        http.client.request.duration:
          attributes:
            subgraph.name: true
            # If status code == 504 then the subgraph HTTP request timed out.
            http.response.status_code:
              subgraph_response_status: code
```

#### Migrating from `apollo_router_graphql_error`

The `apollo.router.graphql_error` counts all individual GraphQL errors in router responses, which can be problematic. For example, a single invalid GraphQL document may have many validation errors, and these would all be counted individually. The metric could report dozens of validation errors, that actually all originate from one request.

There is no exact equivalent for this deprecated metric. Instead, use a [custom instrumentation] attribute and pick a strategy for how you'd like the errors to be reported. An instrument at the `supergraph` stage can inspect JSON error responses using the `response_errors` selector.

This example reports only the first error code for each error response:

```yaml title="router.yaml"
telemetry:
  instrumentation:
    instruments:
      supergraph:
        supergraph.response.errors:
          type: counter
          value: event_unit
          description: Number of requests with GraphQL errors
          unit: req
          attributes:
            graphql.operation.name: true
            errors.code:
              response_errors: $[0].extensions.code
          condition:
            exists:
              response_errors: $.*.extensions.code
```

This example reports all error codes in each error response as an array attribute:

```yaml title="router.yaml"
telemetry:
  instrumentation:
    instruments:
      supergraph:
        supergraph.response.errors:
          type: counter
          value: event_unit
          description: Number of requests with GraphQL errors
          unit: req
          attributes:
            graphql.operation.name: true
            errors.codes:
              response_errors: $.*.extensions.code
          condition:
            exists:
              response_errors: $.*.extensions.code
```

[custom instrumentation]: https://www.apollographql.com/docs/graphos/reference/router/telemetry/instrumentation/instruments#custom-instruments
