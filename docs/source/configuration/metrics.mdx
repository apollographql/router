---
title: Router Metrics
subtitle: Export Apollo Router metrics for Prometheus and OpenTelemetry
description: Export and collect metrics from the Apollo Router with Prometheus and OpenTelemetry Collector.
---

The Apollo Router exports metrics for collection by [Prometheus](./exporters/prometheus) and [OpenTelemetry Protocol (OTLP)](./exporters/opentelemetry), with support for [Datadog via OTLP](./exporters/datadog-otlp).

In `router.yaml`, you configure router metrics with the following settings:

- `telemetry.metrics.common`. Configure values for the router and common across metrics exporters.
- `telemetry.metrics.prometheus`. Configure the Prometheus exporter.
- `telemetry.metrics.otlp`. Configure the OpenTelemetry exporter. Supports sending traces to Datadog.

## Configure common metrics settings

Common settings for router metrics include:

* [Service name](#service-name)
* [Resource attributes](#resource)
* [Custom historgram buckets](#custom-histogram-buckets)

### Service name

Set a service name for your router metrics so they can be easily searched and found in your metrics dashboards. 

The service name can be set by an environment variable or in `router.yaml`, with the following order of precedence (first to last):

1. `OTEL_SERVICE_NAME` environment variable
2. `OTEL_RESOURCE_ATTRIBUTES` environment variable
3. `telemetry.metrics.common.service_name` in `router.yaml`

      <ExpansionPanel title="Example service_name">

      Example setting service name in `telemetry.metrics.common.service_name`:

      ```yaml title="router.yaml"
      telemetry:
        metrics:
          common:
            # (Optional) Set the service name to easily find metrics related to the apollo-router in your metrics dashboards
            service_name: "router" #highlight-line
      ```

      </ExpansionPanel>


4. `telemetry.metrics.common.resource` in `router.yaml`

      <ExpansionPanel title="Example resource">

      Example setting service name in `telemetry.metrics.common.resource`:

      ```yaml title="router.yaml"
      telemetry:
        metrics:
          common:
            resource:
              # (Optional) Set the service name to easily find metrics related to the apollo-router in your metrics dashboards
              "service.name": "router" #highlight-line
      ```

      </ExpansionPanel>

If the service name isn't explicitly set, then by default the service name will be set to `unknown_service:apollo_router` (or `unknown_service` if the executable name cannot be determined).

### Resource attribute

A resource attribute is a set of key-value pairs that provide additional information to an exporter. Application performance monitors (APM) may interpret and display resource information. 

In `router.yaml`, resource attributes are set in `telemetry.metrics.common.resource`. For example:

```yaml title="router.yaml"
telemetry:
  metrics:
    common:
      resource:
        "environment.name": "production"
        "environment.namespace": "{env.MY_K8_NAMESPACE_ENV_VARIABLE}"
```

For OpenTelemetry conventions for resources, see [Resource Semantic Conventions](https://github.com/open-telemetry/semantic-conventions/blob/main/docs/resource/README.md).


### Custom histogram buckets

You can customize bucket boundaries for all generated histograms by setting `telemetry.metrics.common.buckets` in `router.yaml`. For example:

```yaml title="router.yaml"
telemetry:
  metrics:
    common:
      buckets:
        - 0.05
        - 0.10
        - 0.25
        - 0.50
        - 1.00
        - 2.50
        - 5.00
        - 10.00
        - 20.00
```

## Metrics reference

The following metrics for the Apollo Router are available for Prometheus and OpenTelemetry. Attributes are listed where applicable.

### HTTP

- `apollo_router_http_request_duration_seconds_bucket` - HTTP router request duration
- `apollo_router_http_request_duration_seconds_bucket` - HTTP subgraph request duration, attributes:
  - `subgraph`: (Optional) The subgraph being queried
- `apollo_router_http_requests_total` [**deprecated**] - Total number of HTTP requests by HTTP status
- `apollo_router_timeout` - Number of triggered timeouts
- `apollo_router_http_request_retry_total` - Number of subgraph requests retried, attributes:
  - `subgraph`: The subgraph being queried
  - `status` : If the retry was aborted (`aborted`)

#### Customizing `apollo_router_http_requests`

<Caution>

The `apollo_router_http_requests` metric is deprecated and will be removed in a future release.

</Caution>

You can add custom attributes (OpenTelemetry) and labels (Prometheus) to the `apollo_router_http_requests` metric. Attributes can be static or obtained from requests or responses that are:

* static values (prefer using a resource)
* headers from the request or response.
* a value from context.
* a value from the request or response body ([JSON path](https://goessner.net/articles/JsonPath/)).

An example of configuring these attributes is shown below:

```yaml title="router.yaml"
telemetry:
  metrics:
    common:
      attributes:
        supergraph: # Attribute configuration for requests to/responses from the router
          static:
            - name: "version"
              value: "v1.0.0"
          request:
            header:
              - named: "content-type"
                rename: "payload_type"
                default: "application/json"
              - named: "x-custom-header-to-add"
          response:
            body:
              # Apply the value of the provided path of the router's response body as an attribute
              - path: .errors[0].extensions.http.status
                name: error_from_body
              # Use the unique extension code to identify the kind of error
              - path: .errors[0].extensions.code
                name: error_code
          context:
            # Apply the indicated element from the plugin chain's context as an attribute
            - named: my_key
        subgraph: # Attribute configuration for requests to/responses from subgraphs
          all:
            static:
              # Always apply this attribute to all metrics for all subgraphs
              - name: kind
                value: subgraph_request
            errors: # Only work if it's a valid GraphQL error (for example if the subgraph returns an http error or if the router can't reach the subgraph)
              include_messages: true # Will include the error message in a message attribute
              extensions: # Include extensions data
                - name: subgraph_error_extended_type # Name of the attribute
                  path: .type # JSON query path to fetch data from extensions
                - name: message
                  path: .reason
            # Will create this kind of metric for example apollo_router_http_requests_error_total{message="cannot contact the subgraph",subgraph="my_subgraph_name",subgraph_error_extended_type="SubrequestHttpError"}
          subgraphs:
            my_subgraph_name: # Apply these rules only for the subgraph named `my_subgraph_name`
              request:
                header:
                  - named: "x-custom-header"
                body:
                  # Apply the value of the provided path of the router's request body as an attribute (here it's the query)
                  - path: .query
                    name: query
                    default: UNKNOWN
```

<Note>

OpenTelemetry includes many [standard attributes](https://opentelemetry.io/docs/specs/semconv/attributes-registry/) that you can use these via custom [instruments](./instruments). 

</Note>

### Session

- `apollo_router_session_count_total` - Number of currently connected clients
- `apollo_router_session_count_active` - Number of in-flight GraphQL requests

### Cache

- `apollo_router_cache_size` â€” Number of entries in the cache
- `apollo_router_cache_hit_count` - Number of cache hits
- `apollo_router_cache_miss_count` - Number of cache misses
- `apollo_router_cache_hit_time` - Time to hit the cache in seconds
- `apollo_router_cache_miss_time` - Time to miss the cache in seconds

All cache metrics listed above have the following attributes:

- `kind`: the cache being queried (`apq`, `query planner`, `introspection`)
- `storage`: The backend storage of the cache (`memory`, `redis`)

### Coprocessor

- `apollo_router_operations_coprocessor_total` - Total operations with coprocessors enabled.
- `apollo_router_operations_coprocessor.duration` - Time spent waiting for the coprocessor to answer, in seconds.

The coprocessor operations metric has the following attributes:

- `coprocessor.stage`: string (`RouterRequest`, `RouterResponse`, `SubgraphRequest`, `SubgraphResponse`)
- `coprocessor.succeeded`: bool

### Performance

- `apollo_router_processing_time` - Time spent processing a request (outside of waiting for external or subgraph requests) in seconds.
- `apollo_router_query_planning_time` - Time spent planning queries in seconds.
- `apollo_router_query_planning_warmup_duration` - Time spent planning queries in seconds.
- `apollo_router_schema_load_duration` - Time spent loading the schema in seconds.

### Uplink

- `apollo_router_uplink_fetch_duration_seconds_bucket` - Uplink request duration, attributes:

  - `url`: The Uplink URL that was polled
  - `query`: The query that the router sent to Uplink (`SupergraphSdl` or `License`)
  - `kind`: (`new`, `unchanged`, `http_error`, `uplink_error`)
  - `code`: The error code depending on type (if an error occurred)
  - `error`: The error message (if an error occurred)

- `apollo_router_uplink_fetch_count_total`
  - `status`: (`success`, `failure`)
  - `query`: The query that the router sent to Uplink (`SupergraphSdl` or `License`)

<Note>

The initial call to uplink during router startup is not reflected in metrics.

</Note>

### Subscription

- `apollo_router_opened_subscriptions` - Number of different opened subscriptions (not the number of clients with an opened subscriptions in case it's deduplicated)
- `apollo_router_deduplicated_subscriptions_total` - Number of subscriptions that has been deduplicated
- `apollo_router_skipped_event_count` - Number of subscription events that has been skipped because too many events have been received from the subgraph but not yet sent to the client.

### Batching

- `apollo_router.operations.batching` - A counter of the number of query batches received by the router.
- `apollo_router.operations.batching.size` - A histogram tracking the number of queries contained within a query batch.

### Studio

- `apollo.router.telemetry.studio.reports` - The number of reports submitted to Studio by the Router.
  - `type`: The type of report submitted: "traces" or "metrics"
