version: "3.9"
services:
  redis:
    image: redis:latest
    security_opt:
      - no-new-privileges:true
    read_only: true
    ports:
      - 6379:6379
  postgres:
    image: cimg/postgres:17.6
    security_opt:
      - no-new-privileges:true
    environment:
      POSTGRES_USER: ${USER}
      POSTGRES_DB: ${USER}
    ports:
      - 5432:5432
  zipkin:
    image: openzipkin/zipkin:latest
    security_opt:
      - no-new-privileges:true
    read_only: true
    ports:
      - 9411:9411
  datadog:
    image: ghcr.io/datadog/dd-apm-test-agent/ddapm-test-agent:latest
    security_opt:
      - no-new-privileges:true
    read_only: true
    ports:
      - 8126:8126

  # redis cluster
  redis-cluster-7000:
    image: cimg/redis:7.4.5
    command: [ "redis-server", "--protected-mode", "no", "--port", "7000", "--cluster-enabled", "yes" ]
    network_mode: host
  redis-cluster-7001:
    image: cimg/redis:7.4.5
    command: [ "redis-server", "--protected-mode", "no", "--port", "7001", "--cluster-enabled", "yes" ]
    network_mode: host
  redis-cluster-7002:
    image: cimg/redis:7.4.5
    command: [ "redis-server", "--protected-mode", "no", "--port", "7002", "--cluster-enabled", "yes" ]
    network_mode: host
  redis-cluster-7003:
    image: cimg/redis:7.4.5
    command: [ "redis-server", "--protected-mode", "no", "--port", "7003", "--cluster-enabled", "yes" ]
    network_mode: host
  redis-cluster-7004:
    image: cimg/redis:7.4.5
    command: [ "redis-server", "--protected-mode", "no", "--port", "7004", "--cluster-enabled", "yes" ]
    network_mode: host
  redis-cluster-7005:
    image: cimg/redis:7.4.5
    command: [ "redis-server", "--protected-mode", "no", "--port", "7005", "--cluster-enabled", "yes" ]
    network_mode: host
  redis-cluster-startup:
    image: cimg/redis:7.4.5
    command: [ "sh", "-c", "sleep 30; echo yes | redis-cli --cluster create --cluster-replicas 1 localhost:7000 localhost:7001 localhost:7002 localhost:7003 localhost:7004 localhost:7005" ]
    network_mode: host

