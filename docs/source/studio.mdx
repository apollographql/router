---
title: Setting up managed federation
sidebar_title: Managed federation
---

## Connecting to Apollo Uplink

Uplink is the Apollo-hosted endpoint that your gateway polls to fetch its latest supergraph schema.
To set up the schema download, create an API key at the "Contributor" level and put it in the `APOLLO_KEY`
environment variable, and the graph reference in `APOLLO_GRAPH_REF`.

## Spaceport

Spaceport reports usage data to the Apollo ingress. You can see how it is configured in the examples above.

NB: This component is still evolving and you should expect functionality to change and evolve here. We are actively seeking user feedback as we work to shape this component.

### No usage reporting

If you don't wish to take advantage of usage reporting, then no configuration is required. This is the default.

### Usage reporting

To enable usage reporting, set up the `APOLLO_KEY` and `APOLLO_GRAPH_REF`
environment variables as with Apollo Uplink.  The graph reference must refer to a valid graph/variant combination
against which statistics are reported. The `key` must be a valid,
[Contributor API key](https://www.apollographql.com/docs/studio/org/members/#organization-wide-member-roles) which can be used for reporting statistics.
For more details on this process, refer to the [usage reporting documentation](https://www.apollographql.com/docs/studio/metrics/usage-reporting/)


### Spaceport configuration

Spaceport can either be run as an internal, router-specific component or as an external resource shared by multiple routers.

```yaml:title=configuration.yaml
# Spaceport configuration. These values are the default values if not specified
spaceport:
  # By default, Apollo Router will run an internal collector.  It can be
  # configured to not do this by setting this to `true`.  When `true`, no
  # agent will spawn and we will attempt to communicate to `collector` below.
  external: false
  
  # This can be left unconfigured when `external` is `false`.  When `true`,
  # this should be the location of a spaceport that is running external from
  # the Router.
  collector: https://127.0.0.1:50051

  # For an internal spaceport instance (when `external` is `false`), what
  # interface and port should we listen on.
  listener: 127.0.0.1:50051
```

#### Internal spaceport

This is the default appropriate for most cirumstances, including many production deployments.  This is the default collector mode and requires no additional configuration.

In this mode it is possible to further configure the address at which the internal spaceport is listening via the `listener` property.  Configuring a `listener` should only be necessary if there is a clash on the default port that Router chooses (e.g., if running multiple routers or other applications using the same port on the same host), of if it's desirable to change the bind address.

#### External spaceport

Running an external spaceport _is not necessary in most circumstances_.  It may be desireable in certain production environments where configuration of sensitive key data or allocation of reporting resources needs to be operated centrally.  Under heavier workloads, it can also be beneficial to externalize the trace processing to reduce the amount of work that individiual Router instances take on.  The `listener` parameter is ignored for an external spaceport.

To enable the external spaceport, another Router can be run to act as the collector with the exclusive role of processing Studio data.  To configure this, the "collector" should have `external` set to `false` and an appropriate `listener` address and port combination.  Routers exporting Studio data should have `external` set to `true`, `listener` unspecified, and their `collector` property configured to point to the collector Router.

If you're looking for help with this feature, please [open a Discussion](https://github.com/apollographql/router/discussions). 
