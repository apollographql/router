---
title: Response caching telemetry for the GraphOS Router
description: Response caching telemetry for GraphOS Router with GraphOS Enterprise.
minVersion: Router v2.8.0
releaseStage: preview
---

## Metrics

### Instruments

The router provides the `telemetry.instrumentation.instruments.cache` instrument to enable cache metrics:

```yaml title="router.yaml"
telemetry:
  instrumentation:
    instruments:
      cache: # Cache instruments configuration
        apollo.router.operations.response.cache: # A counter which counts the number of cache hit and miss for subgraph requests
          attributes:
            graphql.type.name: true # Include the entity type name. default: false
            subgraph.name: # Custom attributes to include the subgraph name in the metric
              subgraph_name: true
            supergraph.operation.name: # Add custom attribute to display the supergraph operation name
              supergraph_operation_name: string
            # You can add more custom attributes using subgraph selectors
```

You can use custom instruments to create metrics for the subgraph service. The following example creates a custom instrument to generate a histogram that measures the subgraph request duration when there's at least one cache hit for the "inventory" subgraph:

```yaml title="router.yaml"
telemetry:
  instrumentation:
    instruments:
      subgraph:
        only_cache_hit_on_subgraph_inventory:
          type: histogram
          value: duration
          unit: hit
          description: histogram of subgraph request duration when we have cache hit on subgraph inventory
          condition:
            all:
            - eq:
              - subgraph_name: true # subgraph selector
              - inventory
            - gt: # If the number of cache hit is greater than 0
              - response_cache: hit
              # entity_type: Product # Here you could also only check for the entity type Product, it's `all` by default if we don't specify this config.
              - 0

```

### Fetch/insert

| Name | Description | Unit |
| --- | --- | --- |
| `apollo.router.operations.response_cache.fetch.error` | Errors when fetching data from cache | `{error}` |
| `apollo.router.operations.response_cache.fetch` | Time to fetch data from cache | `s` |
| `apollo.router.operations.response_cache.fetch.entity` | Number of entities per subgraph fetch node | `{entity}` |
| `apollo.router.operations.response_cache.insert.error` | Errors when inserting data in cache | `{error}` |
| `apollo.router.operations.response_cache.insert` | Time to insert new data in cache | `s` |

### Invalidation

| Name | Description | Unit |
| --- | --- | --- |
| `apollo.router.operations.response_cache.invalidation.event` | Response cache received a batch of invalidation requests | `{request}` |
| `apollo.router.operations.response_cache.invalidation.error` | Errors when invalidating data in cache | `{error}` |
| `apollo.router.operations.response_cache.invalidation.entry` | Response cache counter for invalidated entries | `{entry}` |
| `apollo.router.operations.response_cache.invalidation.request.entry` | Number of invalidated entries per invalidation request. | `{entry}` |
| `apollo.router.operations.response_cache.invalidation.duration` | Duration of the invalidation event execution, in seconds. | `s` |

### Internal
| Name | Description | Unit |
| --- | --- | --- |
| `apollo.router.response_cache.reconnection` | Number of reconnections to the cache storage | `{retry}` |
| `apollo.router.response_cache.private_queries.lru.size` | LRU cache size for private queries fetched | `{query}` |


### Redis
The latency metrics are marked as experimental because Apollo might change them if there is an upstream change in one of our dependencies.

#### Connection and performance metrics
  - `apollo.router.cache.redis.connections`: Number of active Redis connections
  - `apollo.router.cache.redis.command_queue_length`: Commands waiting to be sent to Redis
  - `apollo.router.cache.redis.commands_executed`: Total number of Redis commands executed
  - `apollo.router.cache.redis.redelivery_count`: Commands retried due to connection issues
  - `apollo.router.cache.redis.errors`: Redis errors by type (auth, timeout, io, etc.)

#### Experimental redis performance metrics
  - `experimental.apollo.router.cache.redis.network_latency_avg`: Average network latency to Redis
  - `experimental.apollo.router.cache.redis.latency_avg`: Average Redis command execution time
  - `experimental.apollo.router.cache.redis.request_size_avg`: Average request payload size
  - `experimental.apollo.router.cache.redis.response_size_avg`: Average response payload size

## Traces

If you're looking at a trace when you have cache hits it looks like this:

<img
  className="screenshot"
  alt="Response cache tracing"
  src="../../../../images/response-cache/trace.png"
  width="300"
/>

You'll have a `response_cache.lookup` span to know how much time was spent to fetch the data from the cache.

When you insert data in the cache another span will be `response_cache.store` to know how much time was spent to insert the data in cache.

For invalidation you can look for `invalidation_endpoint` span.

List of available attributes on `response_cache.lookup`:
- `kind`: `root` or `entity`. Indicates if the cache lookup is for a root field or an entity.
- subgraph.name: the subgraph name
- graphql.type: the type (or parent type for root fields) we're fetching
- debug: boolean to know if the debug mode is enabled or not
- private: boolean to know if it's a private data or not
- contains_private_id: boolean to know if we found private id in context
- cache.key: the primary cache key
- cache.status: `hit`|`partial_hit`|`miss`


List of available attributes on `response_cache.store`:
- kind: either `root` or `entity` to know if we're fetching data for root fields or an entity
- subgraph.name: the subgraph name
- ttl: the ttl of this cache entry
- batch.size: when it's an entity we often batch inserts for entities, it's the size of the batch

## Logs

The router supports a [`response_cache` selector](/router/configuration/telemetry/instrumentation/selectors#subgraph) in telemetry for the subgraph service. The selector returns either the number of cache hits or misses by an entity for a subgraph request or the cache status (`hit`|`partial_hit`|`miss`) for a subgraph request.

For example you can display a log containing all subgraph response data if it's not cached by using this selector:

```yaml title="router.yaml"
telemetry:
  instrumentation:
    events:
      subgraph:
        response:
          level: info
          condition:
            all:
              - eq: # Only for subgraph posts
                  - subgraph_name: true
                  - static: posts
              - eq: # If there's no cache hit in this subgraph response
                  - response_cache: hit
                  - 0
```
