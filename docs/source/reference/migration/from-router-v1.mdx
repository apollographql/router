---
title: Upgrading from Versions 1.x
subtitle: Upgrade from version 1.x to 2.x of GraphOS Router
description: Learn how to upgrade from version 1.x to 2.x of the GraphOS Router.
---

Learn how to upgrade your GraphOS Router deployment from version 1.x to 2.x.

<Note>

GraphOS Router 2.x is available as a [Developer Preview](https://www.apollographql.com/docs/graphos/reference/router-release-lifecycle#developer-preview). The most recent version is **[v2.0.0-preview.1](https://github.com/apollographql/router/releases/tag/v2.0.0-preview.1)**. This upgrade guide will be updated throughout the Developer Preview and will have additions after each release.

</Note>

Router 2.x includes various breaking changes, including removing deprecated features and renaming public interfaces to be more future-proof.

<details>
<summary>Ren√©e Drafting</summary>

- Things you have to do before you upgrade
- Things you have to do in-step with the upgrade
  - Changes to metrics
  - Changes to customization (coprocessors, rhai scripts, and rust plugins)
  - Changes to rust plugins

Removals:
- Support for Scaffold
- `--apollo-uplink-poll-interval` 
- Hot reloading `--supergraph-urls`, `APOLLO_ROUTER_SUPERGRAPH_URLS`
- `--schema`
- Busy timer for request processing duration
- Deprecated methods in rust plugins
  - OneShotAsyncCheckpoint
  - Emitting metrics in plugins
  - `subgraph_name`
- Jaeger tracing

Changes:
- Supergraph endpoint path
- Logging requests and responses
- Renamed metrics
- Changes to metrics selectors (and custom telemetry in general)
- Context key names
- Spec-compliant traces (@TODO figure out what it means)

Validate:
- Traffic shaping
- Apollo operation usage reporting via OTLP
- Introspection depth limit
- Metrics reporting defaults
- CORS configuration
- Header propagation (Should we even mention it if it still works?)

</details>

<details>
<summary>Unsorted items (TODO)</summary>

## New defaults in GraphOS Router v2.0.0-preview.x

### Apollo operation usage reporting via OTLP

The router supports reporting operation usage metrics to GraphOS via OpenTelemetry Protocol (OTLP).

Prior to version 1.49.0 of the router, all GraphOS reporting was performed using a [private tracing format](/graphos/metrics/sending-operation-metrics#reporting-format). In v1.49.0, we introduced support for using OTel to perform this reporting. In v1.x, this is controlled using the `experimental_otlp_tracing_sampler` flag, and it's off by default.

Now in v2.x, this flag is renamed to `otlp_tracing_sampler`, and it's enabled by default.

Learn more about configuring [usage reporting via OTLP](/router/configuration/telemetry/apollo-telemetry#usage-reporting-via-opentelemetry-protocol-otlp).

### Metrics reporting defaults

Default values of some GraphOS reporting metrics have been changed from v1.x to the following in v2.x:

- `telemetry.apollo.signature_normalization_algorithm` now defaults to `enhanced`. (In v1.x the default is `legacy`.)
- `telemetry.apollo.metrics_reference_mode` now defaults to `extended`. (In v1.x the default is `standard`.)

## Removed features in GraphOS Router v2.x

Follow the upgrade steps below for each feature of router v1.x that's been removed in router v2.x.

### Removed busy timer for request processing duration

In `context::Context` that's typically used for router customizations, methods and structs related to request processing duration have been removed, because request processing duration is already included as part of spans sent by the
router. Users customizing the router with Rhai scripts, Rust scripts, or coprocessors don't need to track this information manually. 

**Upgrade step**: remove calls and uses of the following methods and structs from `context::Context`:

- `context::Context::busy_time()`
- `context::Context::enter_active_request()`
- `context::BusyTimer` struct
- `context::BusyTimerGuard` struct

### Removed: `--apollo-uplink-poll-interval`

<!-- PR: https://github.com/apollographql/router/pull/6268 -->

The configurable poll interval of Apollo Uplink has been removed in router v2.x.

**Upgrade step**: remove uses of both the `--apollo-uplink-poll-interval` command-line argument and the `APOLLO_UPLINK_POLL_INTERVAL` environment variable.

## Upgrading to GraphOS Router v2.x

Upgrading from GraphOS Router v1.x to v2.x requires the following steps.

### Introspection depth limit

The [schema-intropsection schema](https://spec.graphql.org/draft/#sec-Schema-Introspection.Schema-Introspection-Schema) is recursive: a client can query the fields of the types of some other fields, and so on arbitrarily deep. This can produce responses that grow much faster than the size of the request.

To protect against abusive requests Router now refuses to execute introspection queries that nest list fields too deep and returns an error instead. The criteria matches `MaxIntrospectionDepthRule` in graphql-js, but may change in future versions.

In case it rejects legitimate queries, this check can be disabled in Router configuration:

```yaml
# Do not enable introspection in production!
supergraph:
  introspection: true # Without this, schema introspection is entirely disabled by default
limits:
  introspection_max_depth: false # Defaults to true
```

### Context Keys

The router request context is used to share data across stages of the request pipeline. The keys have been renamed to prevent conflicts and to better indicate which pipeline stage or plugin populates the data. If you access context entries in a custom plugin, Rhai script, coprocessor, or telemetry selector, update your context keys to account for the new names:

| Previous context key name | New context key name |
| ------------------------- | -------------------- |
| `apollo_authentication::JWT::claims` | `apollo::authentication::jwt_claims` |
| `apollo_authorization::authenticated::required` | `apollo::authorization::authentication_required` |
| `apollo_authorization::scopes::required` | `apollo::authorization::required_scopes` |
| `apollo_authorization::policies::required` | `apollo::authorization::required_policies` |
| `apollo_operation_id` | `apollo::supergraph::operation_id` |
| `apollo_override::unresolved_labels` | `apollo::progressive_override::unresolved_labels` |
| `apollo_override::labels_to_override` | `apollo::progressive_override::labels_to_override` |
| `apollo_router::supergraph::first_event` | `apollo::supergraph::first_event` |
| `apollo_telemetry::client_name` | `apollo::telemetry::client_name` |
| `apollo_telemetry::client_version` | `apollo::telemetry::client_version` |
| `apollo_telemetry::studio::exclude` | `apollo::telemetry::studio_exclude` |
| `apollo_telemetry::subgraph_ftv1` | `apollo::telemetry::subgraph_ftv1` |
| `cost.actual` | `apollo::demand_control::actual_cost` |
| `cost.estimated` | `apollo::demand_control::estimated_cost` |
| `cost.result` | `apollo::demand_control::result` |
| `cost.strategy` | `apollo::demand_control::strategy` |
| `experimental::expose_query_plan.enabled` | `apollo::expose_query_plan::enabled` |
| `experimental::expose_query_plan.formatted_plan` | `apollo::expose_query_plan::formatted_plan` |
| `experimental::expose_query_plan.plan` | `apollo::expose_query_plan::plan` |
| `operation_kind` | `apollo::supergraph::operation_kind` |
| `operation_name` | `apollo::supergraph::operation_name` |
| `persisted_query_hit` | `apollo::apq::cache_hit` |
| `persisted_query_register` | `apollo::apq::registered` |

### Traffic Shaping

<!-- PR: https://github.com/apollographql/router/pull/6486 -->

Traffic shaping has been improved significantly in Router 2.x. We've added a new mechanism, concurrency control, and we've improved the router's ability to observe timeout and traffic shaping restrictions correctly. These improvements do mean that clients of the router may see an increase in:

- [Service Unavailable](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/503)
- [Gateway Timeout](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/504)

errors as traffic shaping constraints are enforced.

We recommend that users experiment with their configuration in order to arrive at the right combination of timeout, concurrency and rate limit controls for their particular use case.

For more information about [configuring traffic shaping](../../routing/performance/traffic-shaping.mdx).

</details>

## CLI flags and environment variables

### Removed: `--schema`

The deprecated `--schema` command-line argument is removed. `router config schema` should be used to print the configuration supergraph instead.



### No hot reloading for `--supergraph-urls`

<!-- PR: https://github.com/apollographql/router/pull/6567 -->

The `--supergraph-urls` command-line argument or the `APOLLO_ROUTER_SUPERGRAPH_URLS` environment variable no longer support hot reloading. In v1.x, if hot reloading was enabled, the router would repeatedly fetch the URLs on the interval specified by `--apollo-uplink-poll-interval`.

If hot reloading from a remote URL is desired, consider running a script to download the supergraph URL on an interval, and point the router to the downloaded file on the filesystem.

## Configuration changes

### Configure supergraph endpoint path

The Router can be configured to receive GraphQL requests at a specific URL path.
If you use the default endpoint path or a path without wildcards, no changes are required.

The syntax for named parameters was changed from a colon to braces:

```yaml
supergraph:
  # Previously:
  # path: /foo/:bar/baz
  path: /foo/{bar}/baz
```

The syntax for wildcards was changed to require braces and a name:

```yaml
supergraph:
  # Previously:
  # path: /foo/*
  path: /foo/{*rest}
```

### Logging requests and responses

<!-- PR: https://github.com/apollographql/router/pull/6285 -->

Router 1.x had an experimental `experimental_when_header` feature to log requests and responses if a request header was set to a specific value.

```yaml title="router.previous.yaml"
telemetry:
  exporters:
    logging:
      # If one of these headers matches we will log supergraph and subgraphs requests/responses
      experimental_when_header: # NO LONGER SUPPORTED
        - name: apollo-router-log-request
          value: my_client
          headers: true # default: false
          body: true # default: false
```

This feature provided very limited control. In Router 2.x, you can achieve much more granular logging using custom telemetry.

This is an example that achieves the same thing as the Router 1.x configuration, logging requests and responses at every stage of the request pipeline:

```yaml title="router.yaml"
telemetry:
  instrumentation:
    events:
      router:
        request: # Display router request log
          level: info
          condition:
            eq:
              - request_header: apollo-router-log-request
              - my_client
        response: # Display router response log
          level: info
          condition:
            eq:
              - request_header: apollo-router-log-request
              - my_client
      supergraph:
        request: # Display supergraph request log
          level: info
          condition:
            eq:
              - request_header: apollo-router-log-request
              - my_client
        response:
          level: info
          condition:
            eq:
              - request_header: apollo-router-log-request
              - my_client
      subgraph:
        request: # Display subgraph request log
          level: info
          condition:
            eq:
              - supergraph_request_header: apollo-router-log-request
              - my_client
        response: # Display subgraph response log
          level: info
          condition:
            eq:
              - supergraph_request_header: apollo-router-log-request
              - my_client
```

### Enforce CORS configuration

In Router 1.x, invalid values in the CORS configuration, such as malformed regexes, were ignored with an error logged.
In Router 2.x, such values prevent router startup.

If your Router 2.x fails to start with an error message like this:

```
could not create router: CORS configuration error:
```

Check the [CORS configuration documentation](../../routing/security/cors) and fix the problems or delete the invalid values.

### Header propagation

<!-- PR: https://github.com/apollographql/router/pull/6621 -->

[Header propagation](/docs/graphos/routing/header-propagation#insert) lets you select data from a client request body using a JSON path, and pass it to subgraphs in a header.

In 2.x, a spec-compliant [JSONPath](https://www.ietf.org/archive/id/draft-goessner-dispatch-jsonpath-00.html) path is used, so a `$` is now required to select the root element:

```yaml
headers:
  all:
    request:
      - insert:
          name: from_app_name
          # Previously:
          # path: .extensions.metadata[0].app_name
          path: $.extensions.metadata[0].app_name
```

### Default Apollo usage reporting protocol
<!-- XXX(@goto-bus-stop) This is not really breaking, should we even say it? --->

If your router v1.x is configured with `experimental_otlp_tracing_sampler`, rename it to `otlp_tracing_sampler`.

To [report operation usage metrics to GraphOS via OTLP](#apollo-operation-usage-reporting-via-otlp), you can either remove your configuration of `otlp_tracing_sampler` and use its default value, or you can explicitly enable it by setting it to [`always_on` or a sampling ratio](/router/configuration/telemetry/apollo-telemetry#configuring-usage-reporting-via-otlp).

Otherwise, to use the behavior of v1.x, turn off usage reporting via OTLP by setting `otlp_tracing_sampler` to `always_off`.

<!-- TODO(@goto-bus-stop): what is the behaviour in 1.x? why would someone want to revert to it? -->

### Default GraphOS metrics reporting
<!-- XXX(@goto-bus-stop) This is not really breaking, should we even say it? --->

Default values of some GraphOS reporting metrics have been changed from v1.x to the following in v2.x:

- `telemetry.apollo.signature_normalization_algorithm` now defaults to `enhanced`. (In v1.x the default is `legacy`.)
- `telemetry.apollo.metrics_reference_mode` now defaults to `extended`. (In v1.x the default is `standard`.)

## Changes affecting telemetry

Over the course of Router 1.x, we have started leaning more heavily on OpenTelemetry, and introduced metrics following OpenTelemetry conventions.
Additionally, we introduced [Custom Instruments](/docs/graphos/reference/router/telemetry/instrumentation/instruments#custom-instruments) which can better address specific use cases.

### Jaeger Tracing

The `jaeger` exporter has been **removed** as Jaeger fully supports the OTLP format. To use the `otlp` exporter, change your router config:

```yaml title="router.yaml"
telemetry:
  exporters:
    tracing:
      propagation:
        jaeger: true
      otlp:
        enabled: true
```

And ensure that you have enabled OTLP support in your Jaeger instance using `COLLECTOR_OTLP_ENABLED=true` and exposing ports `4317` and or `4318` for gRPC and HTTP respectively.

### Traces

`telemetry.instrumentation.spans.mode` becomes `spec_compliant` by default instead of `deprecated`.

### Renamed Metrics

Some of the Router's older metris were not using the OpenTelemetry `.`-namespaced naming convention and were instead separated by `_`.

In Router 2.x, these metrics are renamed:

| Previous metric | Renamed metric |
| --------------- | -------------- |
| `apollo_router_opened_subscriptions` | `apollo.router.opened.subscriptions` |
| `apollo_router_cache_hit_time` | `apollo.router.cache.hit.time` |
| `apollo_router_cache_size` | `apollo.router.cache.size` |
| `apollo_router_cache_miss_time` | `apollo.router.cache.miss.time` |
| `apollo_router_state_change_total` | `apollo.router.state.change.total` |
| `apollo_router_span_lru_size` | `apollo.router.exporter.span.lru.size` $_{[1]} |
| `apollo_router_session_count_active` | `apollo.router.session.count.active` |
| `apollo_router_uplink_fetch_count_total` | `apollo.router.uplink.fetch.count.total` |
| `apollo_router_uplink_fetch_duration_seconds` | `apollo.router.uplink.fetch.duration.seconds`|

$_{[1]} `apollo.router.exporter.span.lru.size` now also has an additional `exporter` prefix.

### Removed metrics

Over the course of Router 1.x, we have introduced many standard OpenTelemetry metrics and added metrics following the OpenTelemetry naming conventions.

The following metrics have now been removed:

- `apollo_router_http_request_retry_total`. Use the `http.client.request.duration`
  metric's `http.request.resend_count` attribute. Set [`default_requirement_level`](/docs/graphos/reference/router/telemetry/instrumentation/instruments#default_requirement_level)
  to `recommended` to make the Router emit this attribute.

- `apollo_router_timeout`. This metric conflated timed-out requests from client
  to the router, and requests from the router to subgraphs. Timed-out requests
  have HTTP status code 504. Use the `http.response.status_code` attribute on the
  `http.server.request.duration` metric to identify timed-out router requests, and
  the same attribute on the `http.client.request.duration` metric to identify
  timed-out subgraph requests.

- `apollo_router_http_requests_total`. This is replaced by
  `http.server.request.duration` metric for requests from clients to router and
  `http.client.request.duration` for requests from router to subgraphs.

- `apollo_router_http_request_duration_seconds_bucket`. This is replaced by
  `http.server.request.duration` metric for requests from clients to router and
  `http.client.request.duration` for requests from router to subgraphs.

- `apollo_router_session_count_total`. This is replaced by
  `http.server.active_requests`.

- `apollo_require_authentication_failure_count`. Use the
  `http.server.request.duration` metric's `http.response.status_code` attribute.
  Requests with authentication failures have HTTP status code 401.

- `apollo_authentication_failure_count`. Use the
  `apollo.router.operations.authentication.jwt` metric's
  `authentication.jwt.failed` attribute.

- `apollo_authentication_success_count`. Use the
  `apollo.router.operations.authentication.jwt` metric instead. If the
  `authentication.jwt.failed` attribute is _absent_ or `false`, the authentication
  succeeded.

- `apollo_router_deduplicated_subscriptions_total`. Use the
  `apollo.router.operations.subscriptions` metric's `subscriptions.deduplicated`
  attribute.

- `apollo_router_cache_miss_count`. Cache miss count can be derived from `apollo.router.cache.miss.time`.

- `apollo_router_cache_hit_count`. Cache hit count can be derived from `apollo.router.cache.hit.time`.

### Removed processing time

Calculating the overhead of injecting the router into your service stack when
making multiple downstream calls is a complex task. With that, we are removing
the following two misleading metrics and recommending that you instead test your
workloads with the router to if the latency meets your requirements:
- `apollo_router_span`
- `apollo_router_processing_time`

### Changes to custom instrumentation selectors

<!-- PR: https://github.com/apollographql/router/pull/6621 -->

The `subgraph_response_body` selector is removed in favor of `subgraph_response_data` and `subgraph_response_errors`.

```diff
telemetry:
  instrumentation:
    instruments:
      subgraph:
        http.client.request.duration:
          attributes:
            http.response.status_code:
              subgraph_response_status: code
            my_data_value:
              # Previously:
              # subgraph_response_body: .data.test
              subgraph_response_data: $.test # The data object is the root object of this selector
            my_error_code:
              # Previously:
              # subgraph_response_body: .errors[*].extensions.extra_code
              subgraph_response_errors: $[*].extensions.extra_code # The errors object is the root object of this selector
```

## Changes affecting Rust plugins

The architectural improvements in Router 2.x affect most custom Rust plugins. In Router 1.x, a brand new `tower::Service` pipeline was built for every request, and so Rust plugin hooks were called for every request. Now, we the `tower::Service` pipeline is built once, and cloned for every request.

This change means you must carefully audit how your Rust plugins store state in any `tower` services you add to the pipeline.

### Removal of `OneShotAsyncCheckpointLayer` and `.oneshot_checkpoint_async()`

This has been removed because it is incompatible with the architectural optimizations we've made in Router 2.x. You can replace it easily with `AsyncCheckpointLayer` as follows:

Plugin code using `OneShotAsyncCheckpointLayer`

```rust
OneShotAsyncCheckpointLayer::new(move |request: execution::Request| {
    let request_config = request_config.clone();
    // ...
})
.service(service)
.boxed()
```

Replace with `AsyncCheckpointLayer`

```rust
use apollo_router::layers::async_checkpoint_layer::AsyncCheckpointLayer;

AsyncCheckpointLayer::new(move |request: execution::Request| {
    let request_config = request_config.clone();
    // ...
})
.buffered()
.service(service)
.boxed()
```

Similarly, usage of `apollo_router::layers::ServiceBuilderExt::oneshot_checkpoint_async` must be updated to use the `checkpoint_async` method.

The `buffered()` method is provided by the `apollo_router::layers::ServiceBuilderExt` trait and ensures that your service may be cloned.

### Removal of deprecated methods

The following deprecated methods are removed from the public crate API available to Rust plugins:

- `services::router::Response::map()`
- `SchemaSource::File.delay` field
- `ConfigurationSource::File.delay` field
- `context::extensions::sync::ExtensionsMutex::lock()`. Use `ExtensionsMutex::with_lock()` instead.
- `test_harness::TestHarness::build()`. Use `TestHarness::build_supergraph()` instead.
- `PluginInit::new()`. Use `PluginInit::builder()` instead.
- `PluginInit::try_new()`. Use `PluginInit::try_builder()` instead.

### Changes to structures

<!-- TODO(@goto-bus--stop): These properties are not actually public, so it probably doesn't affect users? -->

These properties are now a `String` type instead of an `Option<String>` type:
- `services::subgraph::Request::subgraph_name`
- `services::subgraph::Response::subgraph_name`

### Emitting custom metrics

Previously, Rust plugins could use the Router's internal metrics system using the `tracing` macros. This is no longer supported, and the opentelemetry crates should be used instead.

`tracing` field names starting with these strings are no longer treated specially:
- `counter.`
- `histogram.`
- `monotonic_counter.`
- `value.`

Instead, use the [OpenTelemetry](https://docs.rs/opentelemetry/latest/opentelemetry/) crates.
You can use the new `apollo_router::metrics::meter_provider()` API to access the router's global meter provider to register your instruments.

The Router now logs an error every time it detects a legacy metric field in a `tracing` event.

### Changes to context keys

Request and response types carry a `Context` value that can be used by different pipeline stages to communicate information with each other.
Context keys added by the Router have been renamed to prevent collisions with user-provided context keys.
If you are using any Router-provided context keys in your plugins, see the [context keys section][TODO] of the upgrade guide.

### Support for Scaffold

<!-- PR: https://github.com/apollographql/router/pull/6274 -->

In Router v1.x Scaffold could be used to generate boilerplate source code for a Rust Plugin which extended functionality in a custom Router. This facility has been removed.

Source code generated using Scaffold will continue to compile; so existing Rust plugins will be unaffected by this change.

## Deploy your router

Make sure that you are referencing the correct router release: **v2.0.0-preview.0**

During upgrade, carefully monitor logs and resource consumption to ensure that your router has successfully upgraded and that your router has enough resources to perform as expected. The router will automatically migrate required configuration changes, but it is good practice to review the steps above and decide if you want to change your configuration.

For example, you may decide that you wish to change the way in which you sample OTLP traces in this new release and not simply preserve your existing configuration.

## Reporting upgrade issues

If you encounter an upgrade issue that isn't resolved by this article, please search for existing [GitHub discussions](https://github.com/apollographql/router/discussions/) and start a new discussion if you don't find what you're looking for.
