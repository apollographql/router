---
title: Query batching
description: Receive query batches with the Apollo Router  
---

> **Experimental Feature**  
> The Apollo Router provides *experimental* support for client query batching.

Learn about query batching and how to configure the Apollo Router to receive query batches.

## About query batching

Modern applications use several operations to render a single page. This is usually the result of a component-based architecture where individual micro-frontends (MFE) make requests separately to fetch data relevant to them. Not only does this cause a performance overhead (i.e. different components may be requesting the same data), it can also cause a consistency issue. To combat this, MFE-based UIs batch multiple client queries and operations, issued close together, into one HTTP request. This is supported in Apollo Client and Apollo Server.

The Apollo Router now supports client request batching. If youâ€™re using Apollo Client, you can leverage the built-in support for batching to reduce the number of individual requests sent to the router.

Once configured, Apollo Client will automatically combine multiple operations into a single HTTP request. The number of operations within a batch is client configurable, including the maximum number of operations in a batch and the maximum duration to wait for operations to accumulate before sending the batch request. 

The Apollo Router must be configured to receive batch requests, otherwise it rejects them. When processing a batch request, the router deserializes and processes each operation of a batch independently, and it responds to the client only after all operations of the batch have been completed.

## Configure query batching

Both a client and the Apollo Router need to be configured to support query batching.

### Configure router

By default, receiving client request batches is disabled in Apollo Router. 

To enable query batching, set the following fields in your `router.yaml` configuration file:

```yaml title="router.yaml"
experimental_batching:
  enabled: true
  mode: batch_http_link
```

| Attribute | Description | Valid Values | Default Value |
| :-- | :-- | :-- | :-- |
| `enabled` | Flag to enable reception of client batches | boolean | `false` |
| `mode` | Supported client batching mode | `batch_http_link`:  the client uses Apollo Link and its [`BatchHttpLink`](/react/api/link/apollo-link-batch-http) link. | No Default |

### Configure client

To enable batching in a client, configure `BatchHttpLink`. For details on implementing `BatchHttpLink`, see [batching operations](https://www.apollographql.com/docs/react/api/link/apollo-link-batch-http/).

### Configuration compatibility

If the router receives a query batch from a client, and batching is *not* enabled, the router sends a `BATCHING_NOT_ENABLED` error to the client, which clearly identifies why the query batch failed.

## Metrics for query batching

Metrics in the Apollo Router for query batching:

<table class="field-table metrics">
  <thead>
    <tr>
      <th>Name</th>
      <th>Attributes</th>
      <th>Description</th>
    </tr>
  </thead>

<tbody>
<tr class="required">
<td style="min-width: 150px;">

##### `apollo.router.operations.batching`

</td>
<td>

mode

</td>
<td>

Counter for the number received batch requests.

</td>
</tr>

</tbody>
</table>


## Query batch formats

### Request format

```graphql
[
query MyFirstQuery {
  me {
    id
  }
},
query MySecondQuery {
  me {
    name
  }
}
]
```

### Response format

Responses are provided in JSON array, with ordering of responses matching the supplied request.

```json
[
  {"data":{"me":{"id":"1"}}},
  {"data":{"me":{"name":"Ada Lovelace"}}}
]
```

## Error handling for query batching

### Batch error

If a batch of queries cannot be processed, the entire batch will fail. 

For example, this query is invalid because it has two commas to separate the batch of queries:

```graphql
[
query MyFirstQuery {
  me {
    id
  }
},,
query MySecondQuery {
  me {
    name
  }
}
]
```

As a result, an error is returned for the invalid batch:

```json
{"errors":
  [
    {"message":"Invalid GraphQL request","extensions":{"details":"failed to deserialize the request body into JSON: expected value at line 1 column 54","code":"INVALID_GRAPHQL_REQUEST"}}
  ]
}
```

### Individual query error

If a single query in a batch cannot be processed, this will result in an individual error. 

For example, the query `MyFirstQuery` is accessing a field that doesn't exist, while the rest of the batch query is valid.

```graphql
[
query MyFirstQuery {
  me {
    thisfielddoesnotexist
  }
},
query MySecondQuery {
  me {
    name
  }
}
]
```

As a result, an error is returned for the individual query:

```json
[
  {"errors":
    [
      {"message":"cannot query field 'thisfielddoesnotexist' on type 'User'",
       "extensions":{"type":"User","field":"thisfielddoesnotexist","code":"INVALID_FIELD"}
      }
    ]
  },
  {"data":{"me":{"name":"Ada Lovelace"}}}
]
```

## Known limitations

### Unsupported query modes
 
When batching is enabled, any mode of querying that results in a stream of responses is unsupported, including:
- `@defer`
- subscriptions
